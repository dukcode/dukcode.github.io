---
layout: single
title: "[CI/CD] (7) ë°°í¬ ìë™í™” - 3"
categories: cicd
tag: [cicd, jenkins, sonarqube, jacoco, checkstyle, github, nginx, blue-green]
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "docs"
header:
  teaser: "https://i.imgur.com/ksnDOzj.png"
# search: false
---

  ğŸ’¡ **CICD ê³¼ì •**ì€ [LINK](https://dukcode.github.io/cicd-01)ì˜ ê°œìš”ì— ë”°ë¼ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
  ìˆœì„œë¥¼ ë”°ë¥´ë©´ ìˆœì¡°ë¡­ê²Œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
  {: .notice--info} 

# SSH ì ‘ì† ë° Docker Container ì‹¤í–‰

![](https://i.imgur.com/ksnDOzj.png)

ì´ì œ docker hubì— push ì‘ì—…ê¹Œì§€ ì™„ë£Œë˜ì—ˆìœ¼ë‹ˆ ê° branchì— ë§ëŠ” ì„œë²„ì— ì ‘ì†í•´ ë°°í¬ë¥¼ ì§„í–‰í•˜ë©´ ëœë‹¤.

## ì„œë²„ì— Docker ì„¤ì¹˜

ë¨¼ì € ë°°í¬í•˜ê³ ì í•˜ëŠ” ì„œë²„ì— ì ‘ì†í•´ Dockerë¥¼ ì„¤ì¹˜í•œë‹¤.

ì„¤ì¹˜ ê³¼ì •ì€ ê° OSì— ë§ê²Œ [LINK](https://docs.docker.com/engine/install/) ë¥¼ í™•ì¸í•˜ì—¬ ì„¤ì¹˜í•˜ë©´ ëœë‹¤.

dockerëŠ” í•­ìƒ rootë¡œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— sudoë¥¼ ì‚¬ìš©í•˜ì—¬ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì•¼í•˜ëŠ”ë°, í•´ë‹¹ ì‚¬ìš©ìë¥¼ docker ê·¸ë£¹ì— ì¶”ê°€í•¨ìœ¼ë¡œì¨ sudo ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  docker ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```sh
# docker ê·¸ë£¹ì— ìœ ì € ì¶”ê°€
$ sudo usermod -aG docker [username]
# docker daemon restart
$ sudo service docker restart
# ì„œë²„ ì¬ë¶€íŒ…
$ sudo reboot
```

ì„œë²„ì— ì ‘ì†í•´ ìœ„ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ê³  ë‹¤ì‹œ ì ‘ì†í•˜ë©´ `sudo` ì—†ì´ë„ docker ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ëœë‹¤. ê°œë°œ ì„œë²„ì™€ ë°°í¬ ì„œë²„, ëª¨ë“  ì„œë²„ì—ì„œ ìœ„ ê³¼ì •ì„ ì§„í–‰í•˜ë©´ ëœë‹¤.

## ssh credential ìƒì„±

ë¨¼ì € ì„œë²„ì— ì ‘ì†í•˜ê¸° ìœ„í•œ ssh credentialì„ ìƒì„±í•´ì•¼í•œë‹¤.

í•´ë‹¹ private keyëŠ” cicd-testë¼ëŠ” í”„ë¡œì íŠ¸ì— êµ­í•œëœ ê²ƒì´ê¸° ë•Œë¬¸ì—, cicd-test item ìŠ¤ì½”í”„ì— êµ­í•œëœ credentialì„ ìƒì„±í•´ì¤€ë‹¤.

![](https://i.imgur.com/nq03Szj.png)
![](https://i.imgur.com/hW4xqsh.png)

ìœ„ì™€ ê°™ì´ ì…ë ¥í•´ ê°œë°œ ì„œë²„ì™€ ìš´ì˜ ì„œë²„ì— ëŒ€í•œ credentialì„ ìƒì„±í•œë‹¤. ë‚˜ì˜ ì„œë²„ëŠ” passwordì¸ì¦ì„ ì‚¬ìš©í•˜ê³  ìˆì–´ passphraseì— ë¹„ë°€ë²ˆí˜¸ë¥¼ ì±„ì›Œ ë„£ì—ˆì§€ë§Œ, ê³µê°œí‚¤ ì¸ì¦ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš° passphrase ëŒ€ì‹  private keyì˜ Enter directlyë¥¼ í™œì„±í™” í•´, ë¹„ë°€í‚¤ë¥¼ ì ì–´ì£¼ê³  credentialì„ ìƒì„±í•˜ë©´ ëœë‹¤.

![](https://i.imgur.com/LBrpYJc.png)

![](https://i.imgur.com/KyQIvVY.png)
![](https://i.imgur.com/KXZPo4t.png)
![](https://i.imgur.com/VqYgGES.png)

hostì˜ ì´ë¦„ê³¼ portë„ `Jenkinsfile`ì— ì…ë ¥ë˜ë©´ ë³´ì•ˆìƒ ì¢‹ì§€ ì•Šìœ¼ë¯€ë¡œ credentialì„ ì¶”ê°€í•´ì£¼ì—ˆë‹¤. hostì—ëŠ” ì ‘ì† ipë‚˜ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì¤€ë‹¤. PORTëŠ” ì¼ë°˜ì ì¸ sshí¬íŠ¸ì¸ 22ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° í•´ë‹¹ Credentialì„ ë§Œë“¤ í•„ìš”ëŠ” ì—†ë‹¤. `SSH Pipeline Steps`ì˜ Default Portê°€ 22ì´ê¸° ë•Œë¬¸ì´ë‹¤.

## Plugin ì„¤ì¹˜

Jenkinsì— SSH ì ‘ì†ì„ ì›í™œí•˜ê²Œ ë•ëŠ” `SSH Pipeline Steps`ë¥¼ ì„¤ì¹˜í•œë‹¤. ëŒ€í‘œì ì¸ `SSH`ê´€ë ¨ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œëŠ” `SSH Pipeline Steps`ì™€ `Publish Over SSH`ê°€ ìˆë‹¤. í•˜ì§€ë§Œ `Publish Over SSH`ì˜ ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ê°€ 22ë…„ì— ë©ˆì¶”ì—ˆê¸° ë–„ë¬¸ì— ì—…ë°ì´íŠ¸ê°€ í™œë°œí•œ `SSH Pipeline Steps`ë¥¼ ì‚¬ìš©í•˜ê² ë‹¤.

![](https://i.imgur.com/gvNNm2D.png)


ìœ„ì²˜ëŸ¼ `SSH Pipeline Steps` Pluginì„ ì„¤ì¹˜í•´ ì¤€ë‹¤. [ê³µì‹ ë¬¸ì„œ](https://plugins.jenkins.io/ssh-steps/)ì—ì„œ í•´ë‹¹ í”ŒëŸ¬ê·¸ì¸ì˜ ì‚¬ìš©ë°©ë²•ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì´ì œ branchì— ë”°ë¼ ë³€ìˆ˜ë“¤ì´ ìœ ë™ì ìœ¼ë¡œ ë³€ê²½ë  ìˆ˜ ìˆë„ë¡ `Set Varibles` Stageì— ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€í•œë‹¤.

```groovy
stage('Set Variables') {  
    steps {  
        echo 'Set Variables'  
        script {  
            // BASIC  
            PROJECT_NAME = 'cicd-test'  
            REPOSITORY_URL = 'https://github.com/dukcode/cicd-test'  
            PROD_BRANCH = 'main'  
            DEV_BRANCH = 'develop'  
            BRANCH_NAME = env.BRANCH_NAME  
            OPERATION_ENV = BRANCH_NAME.equals(PROD_BRANCH) ? 'prod' : 'dev'  
  
            // DOCKER  
            DOCKER_HUB_URL = 'registry.hub.docker.com'  
            DOCKER_HUB_FULL_URL = 'https://' + DOCKER_HUB_URL  
            DOCKER_HUB_CREDENTIAL_ID = 'DOCKER_HUB_CREDENTIAL'  
            DOCKER_IMAGE_NAME =  OPERATION_ENV + '-' + PROJECT_NAME  
  
            // SSH  
            SSH_CREDENTIAL_ID = OPERATION_ENV.toUpperCase() + '_SSH'  
            SSH_PORT_CREDENTIAL_ID = OPERATION_ENV.toUpperCase() + '_SSH_PORT'  
            SSH_HOST_CREDENTIAL_ID = OPERATION_ENV.toUpperCase() + '_SSH_HOST'  
        }  
    }  
}
```

ìœ„ì™€ ê°™ì´ `SSH` ê´€ë ¨ ë³€ìˆ˜ë“¤ì„ ì¶”ê°€ë¡œ ì‘ì„±í•´ì¤€ë‹¤. ê·¸ëŸ¬ë©´ `SSH_CREDENTIAL_ID`, `SSH_HOST_CREDENTIAL_ID`, `SSH_PORT_CREDENTIAL_ID`ì— ìœ ë™ì ìœ¼ë¡œ ë³€ìˆ˜ê°€ ë‹´ê¸°ê²Œ ëœë‹¤.

## ë‚´ë¶€ í¬íŠ¸ íŒŒì‹±í•˜ê¸°

jenkinsê°€ sshë¡œ ì ‘ì†í•´ docker containerë¥¼ ì‹¤í–‰ì‹œí‚¤ë ¤ë©´ `-p` ì˜µì…˜ìœ¼ë¡œ ë‚´ë¶€í¬íŠ¸ì™€ ì™¸ë¶€í¬íŠ¸ë¥¼ ì ì–´ì£¼ì–´ì•¼ í•œë‹¤.

í”„ë¡œì íŠ¸ê°€ ì‹¤ì œë¡œ ì‘ë™í•  í¬íŠ¸ëŠ” `application.yml`ì— ì¡´ì¬í•œë‹¤. ì´ê²ƒì„ Docker Containerê°€ ë‚´ë¶€í¬íŠ¸ë¡œ ì ì–´ì£¼ì–´ì•¼ ì™¸ë¶€ì™€ í†µì‹ ì´ ê°€ëŠ¥í•˜ë‹¤.

ì´ í¬íŠ¸ë¥¼ jenkinsì—ì„œ credentialì´ë‚˜ í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•œë‹¤ë©´, ë‚´ë¶€í¬íŠ¸ì— ëŒ€í•œ ì •ë³´ê°€ ë‘ ê³³ì— ì¡´ì¬í•˜ê²Œ ëœë‹¤.

`yq`ë€ `yaml`íŒŒì¼ì„ íŒŒì‹±í•  ìˆ˜ ìˆëŠ” í”„ë¡œê·¸ë¨ì´ë‹¤. ìš°ë¦¬ëŠ” í™˜ê²½ì— ë§ëŠ” `application.yml`íŒŒì¼ì—ì„œ portë²ˆí˜¸ë¥¼ íŒŒì‹±í•  ê²ƒì´ë‹¤.

í¬íŠ¸ë²ˆí˜¸ê¹Œì§€ ìˆ¨ê¸¸ ìˆ˜ ìˆë‹¤ë©´ ë³´ì•ˆìƒ ì´ì ì´ ìˆë‹¤ê³  ìƒê°í•˜ì§€ë§Œ, êµ³ì´ ê·¸ë ‡ê²Œ ìƒê°í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì´ ë¶€ë¶„ì„ ë„˜ê²¨ë„ ì¢‹ë‹¤.

### Jenkinsì— `yq` ì„¤ì¹˜

ê°€ì¥ ë¨¼ì € Jenkinsì— ì ‘ì†í•´ `yq`ë¥¼ ì„¤ì¹˜í•˜ì.

```sh
# Jenkins bash ì ‘ì†
$ docker exec -it jenkins /bin/bash

# gpg, git-secret ì„¤ì¹˜
$ apt update
$ apt install gpg git-secret -y

#
$ apt install wget
$ wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
$ chmod a+x /usr/local/bin/yq
$ exit
```

ìœ„ì™€ ê°™ì€ ëª…ë ¹ì–´ë¥¼ í†µí•´ `yq`ë¥¼ Jenkins Containerì— ì„¤ì¹˜í•œë‹¤.

### Port Parsing Stage ì‘ì„±

ë¨¼ì € í¬íŠ¸ ì •ë³´ê°€ ìˆëŠ” `yml`íŒŒì¼ì˜ ì´ë¦„ì„ `Set Variables stage`ì—ì„œ ë³€ìˆ˜ì— ë‹´ì•„ì£¼ì.

```groovy
stage('Set Variables') {  
    steps {  
        echo 'Set Variables'  
        script {  
            // BASIC  
            PROJECT_NAME = 'cicd-test'  
            REPOSITORY_URL = 'https://github.com/dukcode/cicd-test'  
            PROD_BRANCH = 'main'  
            DEV_BRANCH = 'develop'  
            BRANCH_NAME = env.BRANCH_NAME  
            OPERATION_ENV = BRANCH_NAME.equals(PROD_BRANCH) ? 'prod' : 'dev'  
  
            // DOCKER  
            DOCKER_HUB_URL = 'registry.hub.docker.com'  
            DOCKER_HUB_FULL_URL = 'https://' + DOCKER_HUB_URL  
            DOCKER_HUB_CREDENTIAL_ID = 'DOCKER_HUB_CREDENTIAL'  
            DOCKER_IMAGE_NAME =  OPERATION_ENV + '-' + PROJECT_NAME  
  
            // SSH  
            SSH_CREDENTIAL_ID = OPERATION_ENV.toUpperCase() + '_SSH'  
            SSH_PORT_CREDENTIAL_ID = OPERATION_ENV.toUpperCase() + '_SSH_PORT'  
            SSH_HOST_CREDENTIAL_ID = OPERATION_ENV.toUpperCase() + '_SSH_HOST'
            
            // PORT  
            PORT_PROPERTIES_FILE = 'application-' + OPERATION_ENV + '.yml'  
        }  
    }
```

ìœ„ ì²˜ëŸ¼ ì‘ì„±í•¨ë…€ `PORT_PROPERTIES_FILE`ì— `application-dev.yml`ì´ë‚˜ `application-prod.yml`ê³¼ ê°™ì€ í˜•íƒœë¡œ ë¬¸ìì—´ì´ ë‹´ê°„ë‹¤.

ì´ì œ í™˜ê²½ì— ë§ëŠ” ymlíŒŒì¼ì—ì„œ portë¥¼ ì¶”ì¶œí•´ ë³€ìˆ˜ì— ë‹´ëŠ” Stageë¥¼ Build Stage ì „ì— ì¶”ê°€í•´ì¤€ë‹¤.

```groovy
stage('Parse Internal Port') {  
    steps {  
        script {  
            INTERNAL_PORT = sh(script: "yq e '.server.port' ./src/main/resources/${PORT_PROPERTIES_FILE}"  
                , returnStdout: true).trim();  
        }  
    }  
}
```

`yq`ë¥¼ ì´ìš©í•´ `server.port`ì˜ ì •ë³´ë¥¼ `INTERNAL_PORT`ì— ì €ì¥í•œë‹¤. ì´ ì •ë³´ë¥¼ ê°€ì§€ê³  ì‹¤ì œë¡œ ssh ì ‘ì† í›„ docker containerë¥¼ ì‹¤í–‰í•  ë•Œ ì‚¬ìš©í•œë‹¤.

`returnStdOut`ì€ ì„±ê³µì‹œ ê¸°ì¡´ `exit 0` ì‹¤íŒ¨ì‹œ `exit 1`ë¡œ ë¦¬í„´ë˜ëŠ” `sh`ì˜ `return`ê°’ì„ `StdOut`ìœ¼ë¡œ ë°›ì•„ì¤€ë‹¤. ë”°ë¼ì„œ íŒŒì‹±ëœ í¬íŠ¸ ì •ë³´ë¥¼ `INTERNAL_PORT`ì— ë‹´ì„ ìˆ˜ ìˆê²Œ í•œë‹¤.

## ë°°í¬ stage ì‘ì„±

ì´ì œ `Build & Push Docker Image stage` ë‹¤ìŒì— ì‹¤ì œ `SSH`ë¡œ ì ‘ì†í•´ Docker Containerë¥¼ ì‹¤í–‰í•˜ëŠ” `stage`ë¥¼ ì‘ì„±í•˜ë©´ ëœë‹¤. í•´ë‹¹ `stage`ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

```groovy
stage('Deploy to Server') {  
    steps {  
        echo 'Deploy to Server'
        withCredentials([
            usernamePassword(credentialsId: DOCKER_HUB_CREDENTIAL_ID,
                                usernameVariable: 'DOCKER_HUB_ID',
                                passwordVariable: 'DOCKER_HUB_PW'),
            sshUserPrivateKey(credentialsId: SSH_CREDENTIAL_ID,
                                keyFileVariable: 'KEY_FILE',
                                passphraseVariable: 'PW',
                                usernameVariable: 'USERNAME'),
            string(credentialsId: SSH_HOST_CREDENTIAL_ID, variable: 'HOST'),
            string(credentialsId: SSH_PORT_CREDENTIAL_ID, variable: 'PORT')]) {
            
            script {
                def remote = [:]
                remote.name = OPERATION_ENV
                remote.host = HOST
                remote.user = USERNAME
                // remote.password = PW
                // remote.identity = KEY_FILE
                remote.port = PORT as Integer
                remote.allowAnyHosts = true
                
                sshCommand remote: remote, command:  
                    'docker pull ' + DOCKER_HUB_ID + '/' + DOCKER_IMAGE_NAME + ":latest"
    
                sshCommand (remote: remote, failOnError: false, 
                command: 'docker rm -f springboot')

                sshCommand remote: remote, command:
                    ('docker run -d --name springboot'
                    + ' -p 80:' + INTERNAL_PORT
                    + ' -e \"SPRING_PROFILES_ACTIVE=' + OPERATION_ENV + '\"'
                    + ' ' + DOCKER_HUB_ID + '/' + DOCKER_IMAGE_NAME  + ':latest')
            }
        }
    }
}
```

Jenkinsì˜ í•´ë‹¹ stage ë™ì‘ ê³¼ì •ìœ¼ ë‹¤ìŒê³¼ ê°™ë‹¤. ì„œë²„ì—ì„œ ì ‘ì†í•´ docker imageë¥¼ ë‚´ë ¤ë°›ê³  springboot ì´ë¦„ìœ¼ë¡œ ì‹¤í–‰ë˜ê³  ìˆëŠ” ì»¨í…Œì´ë„ˆë¥¼ ë‚´ë¦°ë‹¤. ê·¸ë¦¬ê³  ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆë¥¼ ë„ìš´ë‹¤.

ì„œë²„ì˜ `SSH` ì ‘ì†ë°©ì‹ì´ ê³µê°œí‚¤ ë°©ì‹ì´ë©´ `remote.identity`ì˜ ì£¼ì„ì„ í’€ë©´ ë˜ê³ , ë¹„ë°€ë²ˆí˜¸ ë°©ì‹ì´ë©´ `remote.password`ì˜ ì£¼ì„ì„ í’€ë©´ ëœë‹¤.

ë˜í•œ `SSH` ì ‘ì† ê¸°ë³¸ í¬íŠ¸ì¸ 22ë¥¼ ì‚¬ìš©í•˜ê³  ìˆëŠ” ê²½ìš° `remote.port` ë¼ì¸ì„ ì œê±°í•˜ê³  `SSH_PORT_CREDENTIAL_ID`ì˜ ë‚´ìš©ì„ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ì„ ì œê±°í•˜ë©´ ëœë‹¤.

ê¸°ì¡´ ì‘ë™í•˜ë˜ Docker Containerë¥¼ ë‚´ë¦¬ëŠ” ë¶€ë¶„ì€ í˜„ì¬ ì„œë²„ì— Docker Containerê°€ ì‹¤í–‰ ì¤‘ì´ ì•„ë‹ˆë¼ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•´ í•´ë‹¹ `stage`ê°€ ì¤‘ì§€ë˜ë¯€ë¡œ `failOnError`ë¥¼ `false`ì²˜ë¦¬í•´ì£¼ì—ˆë‹¤.

ì´ì œ ì‹¤ì œë¡œ ì„œë²„ì— ë°°í¬í•˜ëŠ” ê³¼ì •ì„ ì§„í–‰í•˜ê¸° ìœ„í•´ `push`í•´ë³´ì.

```sh
$ git add .
$ git commit -m "chore: Jenkinsfile Deploy stage ì¶”ê°€"
$ git push
```

ìœ„ì™€ ê°™ì´ ì»¤ë°‹í•´ì£¼ê³  Jenkinsì—ì„œ ë¹Œë“œê°€ ì˜ ì§„í–‰ë˜ì—ˆëŠ”ì§€ ì‚´í´ë³´ì.

![](https://i.imgur.com/Yp8cteq.png)

ìœ„ì™€ ê°™ì´ ë¹Œë“œê°€ ì˜ ì§„í–‰ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![](https://i.imgur.com/0QPDc8Y.png)

ìœ„ì™€ ê°™ì´ serverì˜ ì£¼ì†Œë¡œ `/hello` URLë¡œ ì ‘ì†í•´ ë³´ë©´ ì •ìƒ ì‘ë™ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì´ì œ ì™¸ë¶€ì—ì„œ ë‚˜ì˜ í”„ë¡œì íŠ¸ì— ì ‘ì†ì´ ê°€ëŠ¥í•´ì¡Œë‹¤.

ìµœì¢… `Jenkinsfile`ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```groovy
pipeline {  
  
    agent any  
  
    environment {  
        GPG_SECRET_KEY = credentials('GPG_SECRET_KEY')  
    }  
  
    stages {  
        stage('Set Variables') {  
            steps {  
                echo 'Set Variables'  
                script {  
                    // BASIC  
                    PROJECT_NAME = 'cicd-test'  
                    REPOSITORY_URL = 'https://github.com/dukcode/cicd-test'  
                    PROD_BRANCH = 'main'  
                    DEV_BRANCH = 'develop'  
                    BRANCH_NAME = env.BRANCH_NAME  
                    OPERATION_ENV = BRANCH_NAME.equals(PROD_BRANCH) ? 'prod' : 'dev'  
  
                    // DOCKER  
                    DOCKER_HUB_URL = 'registry.hub.docker.com'  
                    DOCKER_HUB_FULL_URL = 'https://' + DOCKER_HUB_URL  
                    DOCKER_HUB_CREDENTIAL_ID = 'DOCKER_HUB_CREDENTIAL'  
                    DOCKER_IMAGE_NAME =  OPERATION_ENV + '-' + PROJECT_NAME  
  
                    // SSH  
                    SSH_CREDENTIAL_ID = OPERATION_ENV.toUpperCase() + '_SSH'  
                    SSH_PORT_CREDENTIAL_ID = OPERATION_ENV.toUpperCase() + '_SSH_PORT'  
                    SSH_HOST_CREDENTIAL_ID = OPERATION_ENV.toUpperCase() + '_SSH_HOST'  
  
                    // PORT  
                    PORT_PROPERTIES_FILE = 'application-' + OPERATION_ENV + '.yml'  
                }  
            }  
        }  
  
        stage('Git Checkout') {  
            steps {  
                echo 'Checkout Remote Repository'  
                git branch: "${env.BRANCH_NAME}",  
                url: REPOSITORY_URL  
            }  
        }  
  
        stage('Git Secret Reveal') {  
            steps {  
                echo 'Git Secret Reveal'  
            sh(script:  
                ('gpg --batch --import ' + GPG_SECRET_KEY + ' && '  
                + ' git secret reveal -f'))  
            }  
        }  
  
        stage('Parse Internal Port') {  
            steps {  
                script {  
                    INTERNAL_PORT = sh(script: "yq e '.server.port' ./src/main/resources/${PORT_PROPERTIES_FILE}"  
                        , returnStdout: true).trim();  
                }  
            }  
        }  
  
        stage('Build') {  
            steps {  
                echo 'Build With gradlew'  
                sh '''  
                    ./gradlew clean build
                '''
                    }  
        }  
  
        stage('Build & Push Docker Image') {  
            steps {  
                echo 'Build & Push Docker Image'  
                withCredentials([usernamePassword(  
                        credentialsId: DOCKER_HUB_CREDENTIAL_ID,  
                        usernameVariable: 'DOCKER_HUB_ID',  
                        passwordVariable: 'DOCKER_HUB_PW')]) {  
  
                    script {  
                        docker.withRegistry(DOCKER_HUB_FULL_URL,  
                                            DOCKER_HUB_CREDENTIAL_ID) {  
                        app = docker.build(DOCKER_HUB_ID + '/' + DOCKER_IMAGE_NAME)  
                        app.push(env.BUILD_ID)  
                        app.push('latest')  
                        }  
  
                    sh(script: """  
                        docker rmi \$(docker images -q \  
                        --filter \"before=${DOCKER_HUB_ID}/${DOCKER_IMAGE_NAME}:latest\" \                        ${DOCKER_HUB_URL}/${DOCKER_HUB_ID}/${DOCKER_IMAGE_NAME})      """, returnStatus: true)  
                    }  
                }  
            }  
        }  
  
        stage('Deploy to Server') {  
            steps {  
                echo 'Deploy to Server'  
                withCredentials([  
                    usernamePassword(credentialsId: DOCKER_HUB_CREDENTIAL_ID,  
                                        usernameVariable: 'DOCKER_HUB_ID',  
                                        passwordVariable: 'DOCKER_HUB_PW'),  
                    sshUserPrivateKey(credentialsId: SSH_CREDENTIAL_ID,  
                                        keyFileVariable: 'KEY_FILE',  
                                        passphraseVariable: 'PW',  
                                        usernameVariable: 'USERNAME'),  
                    string(credentialsId: SSH_HOST_CREDENTIAL_ID, variable: 'HOST'),  
                    string(credentialsId: SSH_PORT_CREDENTIAL_ID, variable: 'PORT')]) {  
  
                    script {  
                        def remote = [:]  
                        remote.name = OPERATION_ENV  
                        remote.host = HOST  
                        remote.user = USERNAME  
                        remote.password = PW  
                        // remote.identity = KEY_FILE  
                        remote.port = PORT as Integer  
                        remote.allowAnyHosts = true  
  
                        sshCommand remote: remote, command:  
                            'docker pull ' + DOCKER_HUB_ID + '/' + DOCKER_IMAGE_NAME + ":latest"  
  
                        sshCommand (remote: remote, failOnError: false,  
                        command: 'docker rm -f springboot')  
  
                        sshCommand remote: remote, command:  
                            ('docker run -d --name springboot'  
                            + ' -p 80:' + INTERNAL_PORT  
                            + ' -e \"SPRING_PROFILES_ACTIVE=' + OPERATION_ENV + '\"'  
                            + ' ' + DOCKER_HUB_ID + '/' + DOCKER_IMAGE_NAME + ':latest')  
                    }  
                }  
            }  
        }  
  
    }  
}
```

## ë¬¸ì œì 

í•´ë‹¹ ì„œë²„ì— docker containerê°€ ì˜ ì˜¬ë¼ê°€ ì™¸ë¶€ì—ì„œ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‹¤. í•˜ì§€ë§Œ í˜„ì¬ ë°°í¬ ë°©ì‹ì€ ë¬¸ì œê°€ ì¡´ì¬í•œë‹¤.

ì„œë²„ì—ì„œ ë°°í¬ê°€ ì¼ì–´ë‚  ë•Œ docker containerê°€ ë‚´ë ¤ê°€ê³  ë‹¤ì‹œ ì˜¬ë¼ê°€ëŠ”  ë™ì•ˆì€ ì„œë²„ ì ‘ì†ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ì¦‰, ë¬´ì¤‘ë‹¨ ë°°í¬ê°€ í•„ìš”í•˜ë‹¤.

ë‹¤ìŒ í¬ìŠ¤íŠ¸ë¶€í„° `Blue Green` ë¬´ì¤‘ë‹¨ ë°°í¬ ë°©ì‹ì„ ì ìš©í•´ ì‚¬ìš©ìê°€ ë°°í¬ê°€ ì¼ì–´ë‚˜ë„ ì¤‘ë‹¨ì—†ì´ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆê²Œ í•´ë³´ì.

ë˜í•œ ì¶”ê°€ê¸°ëŠ¥ë„ ë„£ê³  ì‹¶ë‹¤.

1. ë§¤ ìŠ¤í…Œì´ì§€ê°€ ëë‚  ë•Œ, `Discord`ë‚˜ `Slack`ê°™ì€ SNSë¡œ ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” ì„±ê³µì—¬ë¶€ë¥¼ ë°›ê³ ì‹¶ë‹¤.
2. ì†ŒìŠ¤íŒŒì¼ì„ ì •ì ë¶„ì„í•˜ì—¬ ê¸°ì¤€ì— ì¶©ì¡±í•˜ì§€ ëª»í•˜ë©´ ë¹Œë“œ ê³¼ì •ì„ ë©ˆì¶”ê³  ì‹¶ë‹¤.

ìœ„ì—ì„œ ë¶€ì¡±í•œ ë¶€ë¶„ê³¼ ì¶”ê°€ì ì¸ ê¸°ëŠ¥ì„ ë‹¤ìŒ í¬ìŠ¤íŠ¸ë¶€í„° í•˜ë‚˜í•˜ë‚˜ êµ¬í˜„í•´ë³´ì.