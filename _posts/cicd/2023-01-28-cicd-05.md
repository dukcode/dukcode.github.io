---
layout: single
title: "[CI/CD] (5) ë°°í¬ ìë™í™” - 1"
categories: cicd
tag: [cicd, jenkins, sonarqube, jacoco, checkstyle, github, nginx, blue-green]
toc: true
toc_sticky: true
author_profile: true
sidebar:
  nav: "docs"
header:
  teaser: "https://i.imgur.com/O3Ruq92.png"
# search: false
---

  ğŸ’¡ **CICD ê³¼ì •**ì€ [LINK](https://dukcode.github.io/cicd-01)ì˜ ê°œìš”ì— ë”°ë¼ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
  ìˆœì„œë¥¼ ë”°ë¥´ë©´ ìˆœì¡°ë¡­ê²Œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
  {: .notice--info} 

# Jenkinsì—ì„œ Build ì§„í–‰í•˜ê¸°

![](https://i.imgur.com/O3Ruq92.png)

JenkinsëŠ” `Jenkinsfile`ì„ ì½ê³  ì—¬ëŸ¬ `stage`ë¥¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ê²Œ ëœë‹¤.

Jenkinsì˜ ë°°í¬ ê¸°ë³¸ ê³¼ì •ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

1. githubì—ì„œ ì†ŒìŠ¤íŒŒì¼ì„ checkoutí•´ì˜¨ë‹¤.
2. ì•”í˜¸í™”ëœ íŒŒì¼ì„ git secretì„ ì´ìš©í•´ ë³µí˜¸í™” ì‹œí‚¨ë‹¤.
3. í”„ë¡œì íŠ¸ê°€ ì‹¤í–‰ë  í¬íŠ¸ë¥¼ íŒŒì‹±í•œë‹¤.
4. ì†ŒìŠ¤íŒŒì¼ì„ í…ŒìŠ¤íŠ¸, ë¹Œë“œí•œë‹¤.
5. ë¹Œë“œëœ jaríŒŒì¼ì„ ë„ì»¤ ì´ë¯¸ì§€ë¡œ ë§Œë“¤ê³  ë„ì»¤ í—ˆë¸Œì— pushí•œë‹¤.
6. ê°œë°œ/ìš´ì˜ ì„œë²„ì— ì ‘ì†í•´ ë„ì»¤ ì´ë¯¸ì§€ë¥¼ ë‚´ë ¤ë°›ê³  ê¸°ì¡´ ì»¨í…Œì´ë„ˆë¥¼ ë‚´ë¦° í›„ ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•œë‹¤.
ìœ„ì—ì„œ ë§í–ˆë“¯ì´ ìˆœì„œëŒ€ë¡œ ì ìš©í•´ ë³´ê² ë‹¤.

ìœ„ì˜ ê³¼ì •ëŒ€ë¡œ `stage`ë¥¼ í•˜ë‚˜í•˜ë‚˜ ì‘ì„±í•´ë³´ì.


## Checkout

ê°€ì¥ ë¨¼ì € í”„ë¡œì íŠ¸ ìµœìƒìœ„ì— `Jenkinsfile`ì´ë¼ëŠ” íŒŒì¼ì„ ìƒì„±í•˜ì. ì²« `stage`ì—ì„œëŠ” GIthub ì›ê²© ë¦¬í¬ì§€í† ë¦¬ì—ì„œ ë³€ê²½ì´ ê°ì§€ëœ ë¸Œëœì¹˜ë¥¼ checkout í•´ì˜¬ ê²ƒì´ë‹¤.

```groovy
pipeline {

    agent any

    stages {
        stage('Git Checkout') {
            steps {
                echo 'Checkout Remote Repository'
                git branch: "${env.BRANCH_NAME}",
                url: '[ì›ê²© ë ˆí¬ì§€í† ë¦¬ URL]'
            }
        }
    }
}
```

ìœ„ ì²˜ëŸ¼ ì‘ì„±í•˜ë©´ ë³€ê²½ì´ ê°ì§€ëœ ë¸Œëœì¹˜ë¥¼ checkoutí•´ì˜¤ëŠ” stageê°€ ì™„ì„±ëœë‹¤. ê¸°ë³¸ì ì¸ pipeline syntaxëŠ” [ê³µì‹ ë¬¸ì„œ](https://www.jenkins.io/doc/book/pipeline/syntax/)ë¥¼ ì°¸ê³ í•˜ì.

`git`ì€ jenkins git pluginì¸ë° Jenkinsë¥¼ ì²˜ìŒ ì‹¤í–‰í•  ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ ì„¤ì¹˜ë˜ëŠ” í”ŒëŸ¬ê·¸ì¸ì´ë‹¤. [ê³µì‹ ë¬¸ì„œ](https://www.jenkins.io/doc/pipeline/steps/git/)ì—ì„œ jenkins git pluginì˜ checkout pipeline ì‘ì„± ì˜ˆì‹œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

`env`ëŠ” Jenkinsì˜ ê¸°ë³¸ì ì¸ í™˜ê²½ë³€ìˆ˜ì´ë‹¤. `env`ì˜ variableë“¤ì€ [ê³µì‹ ë¬¸ì„œ](https://www.jenkins.io/doc/book/pipeline/jenkinsfile/#using-environment-variables)ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

- BUILD_ID
- BUILD_NUMBER
- BUILD_TAG
- BUILD_URL
- EXECUTOR_NUMBER
- JAVA_HOME
- JENKINS_URL
- JOB_NAME
- NODE_NAME
- WORKSPACE

ë˜í•œ [ê³µì‹ ë¬¸ì„œ](https://www.jenkins.io/doc/book/pipeline/multibranch/#additional-environment-variables)ì— ë”°ë¥´ë©´ `Multibranch Pipelines`ì—ì„œëŠ” ì¶”ê°€ì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ variableì„ ì¶”ê°€ë¡œ ê°€ì§„ë‹¤.

- BRANCH_NAME
- CHANGE_ID

ë”°ë¼ì„œ ìœ„ì— ìˆëŠ” `BRANCH_NAME`ì„ í™œìš©í•´ ë³€ê²½ì´ ê°ì§€ëœ ë¸Œëœì¹˜ë¥¼ checkoutí•´ ì˜¬ ìˆ˜ ìˆë‹¤.

> **ì°¸ê³  : groovyì˜ double-quoted-stringê³¼ single-quoted-stringì˜ ì°¨ì´**
>
> single-quoted-stringì€ `java.lang.String`ê³¼ ê°™ì€ í´ë˜ìŠ¤ì´ê³ , double-qouted-stringì€ `org.codehaus.groovy.runtime.GStringImpl` í´ë˜ìŠ¤ë¡œì„œ, GStringì´ë¼ê³  ë¶ˆë¦°ë‹¤. GStringì€ lazy loadingì„ ì§€ì›í•´ `${ë³€ìˆ˜ëª…}`ì„ í¬í•¨ì‹œì¼œ `toString()`ì´ í˜¸ì¶œë  ë•Œ ì‹¤ì œ ë¬¸ìì—´ë¡œ ë³€í™˜ëœë‹¤. ì˜ˆì‹œë¡œ ë™ì  SQLë¬¸ì„ ìƒì„±í•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
>
> ìœ„ì™€ ê°™ì€ ì´ìœ ë¡œ branchëª…ì„ ë¶ˆëŸ¬ì˜¬ ë•Œ double-qouted-stringì„ ì‚¬ìš©í–ˆë‹¤.

## ë³µí˜¸í™”

ì´ì œ checkoutí•´ì˜¨ ì†ŒìŠ¤íŒŒì¼ì—ì„œ ì•”í˜¸í™”ëœ íŒŒì¼ì„ ë³µí˜¸í™” í•˜ëŠ” ê³¼ì •ì„ í•´ì•¼í•œë‹¤.

ê°€ì¥ ë¨¼ì € ì•„ê¹Œ ë§Œë“¤ì–´ ë‘ì—ˆë˜ `test-jenkins`ì˜ private keyë¥¼ jenkinsì˜ credentialë¡œ ë“±ë¡í•´ ì¤„ ê²ƒì´ë‹¤.

ê°€ì¥ ë¨¼ì € private-keyë¥¼ ë³µì‚¬í•´ ë³´ì


```sh
$ gpg --export-secret-key test-jenkins > private.key
```

ìœ„ì˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ë©´ private.keyë¼ëŠ” íŒŒì¼ì— private-keyê°€ ì¶”ì¶œëœë‹¤.

ì´ì œ credentialì„ ë§Œë“¤ì–´ jenkinsì— private-keyë¥¼ ë“±ë¡ ì‹œí‚¤ì.

í•´ë‹¹ private keyëŠ” cicd-testë¼ëŠ” í”„ë¡œì íŠ¸ì— êµ­í•œëœ ê²ƒì´ê¸° ë•Œë¬¸ì—, cicd-test item ìŠ¤ì½”í”„ì— êµ­í•œëœ credentialì„ ìƒì„±í•´ë³´ì.

![](https://i.imgur.com/b79xZ6a.png)

`cicd-test` itemì˜ credentialì— ë“¤ì–´ê°„ë‹¤.

![](https://i.imgur.com/o3LA7d5.png)

`cicd-test`ë¥¼ ëˆŒëŸ¬ í•´ë‹¹ ì•„ì´í…œì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œ ë„ë©”ì¸ ëª©ë¡ì— ë“¤ì–´ê°„ë‹¤.

![](https://i.imgur.com/IJipP6d.png)

í˜„ì¬ëŠ” `Global credentials`ë°–ì— ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤. `Add domain`ë²„íŠ¼ì„ ëˆŒëŸ¬ ë„ë©”ì¸ì„ ìƒì„±í•´ ì¤€ë‹¤.
![](https://i.imgur.com/wWUdoCx.png)

ìœ„ì²˜ëŸ¼ ë„ë©”ì¸ í´ë”ë¥¼ ìƒì„±í•œë‹¤. ì´ì œ í•´ë‹¹ itemì—ì„œë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë„ë©”ì¸ì´ ìƒì„±ë˜ì—ˆë‹¤.

![](https://i.imgur.com/WIq0GfF.png)

`Add Credentials`ë²„íŠ¼ì„ ëˆŒëŸ¬ Credentialì„ ì¶”ê°€í•œë‹¤.

![](https://i.imgur.com/RxSWFr2.png)

ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ Credentialì„ ìƒì„±í•  ìˆ˜ ìˆë‹¤. `private.key`ë¥¼ ë“±ë¡í•´ ì¤„ê²ƒì´ê¸° ë•Œë¬¸ì— ìœ„ì™€ ê°™ì´ Secret fileë¡œ Credentialì„ ë“±ë¡í•´ì¤€ë‹¤. ì´ì œ private.keyëŠ” í•„ìš” ì—†ìœ¼ë‹ˆ ì‚­ì œí•´ì¤€ë‹¤.

```sh
$ rm private.key
```

jenkinsì—ì„œ gpgì™€ git-secretì„ ì´ìš©í•´ íŒŒì¼ì„ ë³µí˜¸í™” í•´ì•¼ í•˜ë‹ˆ jenkinsì— ì ‘ì†í•´ gpgì™€ git-secretì„ ì„¤ì¹˜í•´ ì¤€ë‹¤.

```sh
# Jenkins bash ì ‘ì†
$ docker exec -it jenkins /bin/bash

# gpg, git-secret ì„¤ì¹˜
$ apt update
$ apt install gpg git-secret -y

$ exit
```

Jenkinsfile ì˜ `agent any` ë‹¤ìŒì— ë‹¤ìŒ í™˜ê²½ë³€ìˆ˜ ì„¤ì •ì„ í•´ì¤€ë‹¤.

```groovy
agent any

environment {
    GPG_SECRET_KEY = credentials('GPG_SECRET_KEY')
}
```

ë§Œë“¤ì–´ ë†“ì•˜ë˜ Credentialì„ `GPG_SECRET_KEY`ë¼ëŠ” ë³€ìˆ˜ì— ì €ì¥í•œë‹¤. ì´ì œ Jenkinsfileì— ë³µí˜¸í™” stageë¥¼ ì¶”ê°€í•´ ì¤€ë‹¤.

```groovy
stage('Git Secret Reveal') {
    steps {
        echo 'Git Secret Reveal'  
        sh(script:  
            ('gpg --batch --import ' + GPG_SECRET_KEY + ' && '  
            + ' git secret reveal -f'))
    }
}
```

`private.key`ë¥¼ ë“±ë¡ì‹œì¼œë‘” Credentialì„ gpg-keyë¡œ import ì‹œí‚¨ë‹¤. ê·¸ë¦¬ê³  checkoutí•´ì˜¨ ì†ŒìŠ¤íŒŒì¼ì—ì„œ ì•”í˜¸í™”ëœ íŒŒì¼ì„ ë³µí˜¸í™” ì‹œí‚¨ë‹¤.

`String`ë“¤ì„ `+` ë¬¸ë²•ì„ ì‚¬ìš©í•´ ì—°ê²°ì‹œì¼°ëŠ”ë° ì´ëŠ” Credentialì„ ì§ì ‘ `double-quoted-string`ì•ˆì— í˜¸ì¶œí•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ Warningì´ ìƒê¸°ê¸° ë•Œë¬¸ì´ë‹¤.

![](https://i.imgur.com/edAbNNy.png)

í•´ë‹¹ ë°©ë²•ì€ insecureí•˜ë¯€ë¡œ `+`ë¬¸ë²•ì„ ì‚¬ìš©í•´ ë”í•´ì£¼ì.

>`sh`ì— ê´€í•œ ë¬¸ë²•ì€ [ê³µì‹ ë¬¸ì„œ](https://www.jenkins.io/doc/pipeline/steps/workflow-durable-task-step/#sh-shell-script)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë“¯ì´ String íƒ€ì…ì¸ scriptë§Œ í•„ìˆ˜ì´ê³  ë‚˜ë¨¸ì§€ëŠ” optionalì´ë¯€ë¡œ `sh 'aaa'`ì˜ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ë©´ ëœë‹¤. 
>
>`'''`ëŠ” groovyì˜ `Triple-single-quoted String`ìœ¼ë¡œ ì—¬ëŸ¬ì¤„ì˜ ë¬¸ìë¥¼ ì…ë ¥í•˜ëŠ” ë° ìš©ì´í•œ ë¬¸ë²•ì´ë‹¤. í˜„ì¬ ì»¤ë§¨ë“œëŠ” ì—¬ëŸ¬ì¤„ì´ ì•„ë‹ˆì§€ë§Œ ì‹œì¸ì„±ì„ ìœ„í•´ ì‚¬ìš©í–ˆë‹¤. (ì°¸ê³  : [LINK](https://groovy-lang.org/syntax.html#_triple_single_quoted_string))

## Build

ë³µí˜¸í™” ë‹¤ìŒ `stage`ëŠ” í¬íŠ¸ë¥¼ íŒŒì‹±í•˜ëŠ” ê²ƒì´ì§€ë§Œ ë‚˜ì¤‘ì— í•„ìš”ì„±ì´ ìƒê¸¸ ë•Œ ì‘ì„±í•˜ê³  build `stage`ë¥¼ ë¨¼ì € ì‘ì„±í•˜ê² ë‹¤.

ì´ì œ ë°›ì•„ì˜¨ í”„ë¡œì íŠ¸ ì†ŒìŠ¤íŒŒì¼ì„ `gradlew`ë¥¼ ì´ìš©í•´ ë¹Œë“œí•œë‹¤. ë‹¤ìŒê³¼ ê°™ì€ stageë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.

```groovy
stage('Build') {
    steps {
        echo 'Build With gradlew'
        sh '''
            ./gradlew clean build
        '''
    }
}
```

ìœ„ì™€ ê°™ì´ ì‘ì„±í•˜ë©´ `./gradlew clean build`ë¼ëŠ” ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ `build`ë¥¼ ì§„í–‰í•œë‹¤. íŠ¹ë³„í•œ ì„¤ì •ì„ ë§Œì§€ì§€ ì•Šì•˜ë‹¤ë©´ ì—¬ê¸°ì„œ `test`ê°€ ì§„í–‰ë˜ê²Œ ë˜ê³  `test`ë¥¼ í†µê³¼í•˜ì§€ ëª»í•˜ë©´ `build stage`ê°€ ì¤‘ë‹¨ë˜ê³  ë°°í¬ê°€ ì‹¤íŒ¨í•˜ê²Œ ëœë‹¤.

ìµœì¢…ì ì¸ `Jenkinsfile`ì˜ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```groovy
pipeline {

    agent any

    environment {  
        GPG_SECRET_KEY = credentials('GPG_SECRET_KEY')  
    }

    stages {
        stage('Git Checkout') {
            steps {
                echo 'Checkout Remote Repository'
                git branch: "${env.BRANCH_NAME}",
                url: '[ì›ê²© ë ˆí¬ì§€í† ë¦¬ URL]'
            }
        }

        stage('Git Secret Reveal') {
            steps {
                echo 'Git Secret Reveal'  
                sh(script:  
                    ('gpg --batch --import ' + GPG_SECRET_KEY + ' && '  
                    + ' git secret reveal -f'))
            }
        }

        stage('Build') {
            steps {
                echo 'Build With gradlew'
                sh '''
                    ./gradlew clean build
                '''
            }
        }
        
    }
}

```

ì´ì œ ë³€ê²½ì‚¬í•­ì„ pushí•˜ê³  ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì.

```sh
$ git add .
$ git commit -m "chore: Jenkinsfile ìƒì„± ë° checkout, secret reveal, build stage ì¶”ê°€"
$ git push
```

`push` í›„ Jenkinsë¥¼ í™•ì¸í•´ ë³´ì.

![](https://i.imgur.com/20dbUhO.png)

ì„±ê³µì ìœ¼ë¡œ ì§„í–‰ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![](https://i.imgur.com/hXbA47j.png)

`Console Output`ì„ í™•ì¸í•´ë³´ë©´ ìœ„ì²˜ëŸ¼ checkout, ë³µí˜¸í™”, build ê³¼ì •ì´ ì˜ ì§„í–‰ë˜ì—ˆë‹¤ëŠ” ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œëŠ” Buildëœ ê²°ê³¼ë¥¼ Docker Imageë¡œ Buildí•˜ê³  Docker Hubì— Pushí•˜ëŠ” ê³¼ì •ì„ ì§„í–‰í•´ ë³´ì.